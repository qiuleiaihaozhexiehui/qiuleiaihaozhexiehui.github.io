<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>测试题</title>
    <link rel="stylesheet" href="index.css"/>
  </head>
  <body>
    <div class="container"></div>
    <script>
      // 工具函数>>
      let getQueryVariable = function(variable)
      {
          var query = window.location.search.substring(1);
          var vars = query.split("&");
          for (var i=0;i<vars.length;i++) {
                  var pair = vars[i].split("=");
                  if(pair[0] == variable){return pair[1];}
          }
          return(false);
      }
      // <<工具函数
      let getData = function(){
          return new Promise((resolve, reject) => {
              fetch('timu.json')
              .then(res => resolve(res.json()))
              .catch(err => console.log(err));
          })
      };
      let run = async function(Test){
          let number = getQueryVariable('number') || (window.location.href='/dist/login.html');
          let name = getQueryVariable('name') || (window.location.href='/dist/login.html');
          let timuData = await getData();
          
          let test = new Test({
              el: '.container',
              number: number,
              name: name,
              data: timuData
          });
      };
      window.onload = function(){
          // 答题展示的弹窗
          class Layer{
              constructor(name, number){
                  this.name = name;
                  this.number = number;
                  this.initDom();
                  this.onAction();    
              }
              initDom(){
                  let domString = `
                      <div class="cd-popup" role="alert">
                          <div class="cd-popup-container">
                              <p class="cd-popup-content">这里是弹出内容</p>
                              <ul class="cd-buttons">
                              <li><a href="#0">Yes</a></li>
                              <li><a href="#0">No</a></li>
                              </ul>
                              <a class="cd-popup-close img-replace" href="#0">Close</a>
                          </div>
                      </div>`;
                  this.dom = (function(){
                      let temp = document.createElement('div');
                      temp.innerHTML = domString;
                      return temp.children[0];
                  })();
              }
              onAction(){
                  let dom = this.dom.classList.contains('cd-popup') ? this.dom : this.dom.querySelector('.cd-popup');
      
                  dom.addEventListener('click', function(event){
                      if( event.target.classList.contains('cd-popup-close') || event.target.classList.contains('cd-popup') ){
                          event.preventDefault();
                          this.classList.remove('is-visible');
                      }
                  });    
      
                  document.onkeydown = function(event){
                      if( event.which === 27 ){
                          document.querySelector('.cd-popup').classList.remove('is-visible');
                      }
                  }  
              }
              show(result){
                  let scoreBoard = document.querySelector('.cd-popup');
                  scoreBoard.querySelector('.cd-popup-content').innerText = `恭喜你:${this.name}，你获得了${result}`;
                  scoreBoard.classList.add('is-visible');
              }
          }
          // 答题区域的对象
          class AnswerBoard{
              constructor(test, name, number){
                  this.test = test;
                  this.layer = new Layer(name, number);
              }
              info(){
                  let _this = this;
      
                  _this.result = 0;
                  for(let i of _this.test){
                      if(Array.isArray(i)){
                          for(let j of i){
                              _this.result += j.score;
                          }
                      }else{
                          _this.result += i.score;
                      }
                  }
                  
                  _this.layer.show(_this.result);
              }
          }
      
          // 每一道题目的对象
          class Item{
              constructor(item, type){
                  this.id = item.id;
                  this.type = type;
                  this.name = item.name;
                  this.choice = item.choice;
                  this.answer = item.answer;
                  this.score = 0;
      
                  this.panelId = `panel-${this.id}`;
                  this.panelClass = 'panelcontainer';
                  this.panelInfoClass = 'panelinfo';
                  this.panelResClass = 'panelres';
                  this.itemClass = 'panelitem'
              }
              update(){
                  let _this = this;
      
                  let itemContainer = document.createElement('div');
                  itemContainer.setAttribute('id', _this.panelId);
                  itemContainer.classList.add(_this.panelClass);
      
                  let answerGroup = document.createElement('div');
                  answerGroup.classList.add(_this.panelResClass);
                  answerGroup.innerHTML = (function(){
                      let temp = [];
                      let type = _this.type === 'sigle' ? 'radio' : 'checkbox';
                      for(let key in _this.choice){
                          temp.push(`<div class='${_this.itemClass}'><input type='${type}' name='${_this.id}' value='${key}' />${key}、${_this.choice[key]}</div>`);
                      }
                      return temp.join('');
                  })();
                  answerGroup.addEventListener('click', this.onClick.bind(this, answerGroup));
      
                  // 渲染题目信息
                  itemContainer.appendChild((function(){
                      let temp = document.createElement('div');
                      temp.classList.add(_this.panelInfoClass);
                      temp.innerHTML = `${_this.id}、${_this.name}`;
                      return temp;
                  })());
                  // 渲染答案组
                  itemContainer.appendChild(answerGroup);
                  return itemContainer;
              }
              onClick(e){
                  let _this = this;                        
                  let group = e.querySelectorAll(`input[name='${_this.id}']`);
      
                  // 根据不同的题目类型进行分数计算
                  if (_this.type === 'sigle'){
                      _this.countScoreSigle(group);
                  }else if(_this.type === 'mutil'){
                      _this.countScoreMutil(group);
                  }
              }
              countScoreSigle(group){
                  let _this = this;
                  for (let i = 0; i < group.length; i++) { //遍历Radio 
                      if (group[i].checked && group[i].value === _this.answer) {
                          this.score = 5;
                          return;                
                      }
                  }
                  // 如果没有选择对，那么就结果为false
                  this.score = 0;
              }
              countScoreMutil(group){
                  let _this = this;
                  // 获取标准答案
                  let result = typeof _this.answer === 'string' ? [_this.answer] : _this.answer;
                  // 获取有哪些选项
                  let selected = [];
                  for (let i = 0; i < group.length; i++) { //遍历Radio 
                      if (group[i].checked) {
                          selected.push(group[i].value);               
                      }
                  }
                  let judge = function(A, B){
                      for (var elem of B) {
                          if (A.indexOf(elem) === -1) {
                              return false;
                          }
                      }
                      return true;
                  }
                  // 多选不得分
                  if(selected.length > result.length && judge(selected, result)){
                      _this.score = 0;
                  }
                  // 选错一个不得分
                  // else if(judge(result, selected)){
                  //    _this.score = 0;
                  // }
                  // 少选得三分
                  else if(selected.length < result.length && judge(result, selected)){
                      // 少选
                      _this.score = 3;
                  }                        
                  // 刚好得五分
                  else if(selected.length == result.length && judge(result, selected)){
                      _this.score = 5;
                  }
                  else{
                      _this.score = 0;
                  }
              }
          }
      
          // 题库的对象
          class Test{
              constructor(options){
                  this.el = options.el
                  this.name = options.name;
                  this.number = options.number;
                  // 单选
                  this.sigleitems = [];
                  // 多选
                  this.mutilitems = [];
                  this.titleClass = 'contenttitle';
                  this.cateClass = 'catecontainer';
                  this.cateTitleClass = 'catetitle';
                  this.buttonClass = 'contentbutton';
                  // 初始化题目
                  this.init(options.data);
                  // 初始化答题板
                  this.answerBoard = new AnswerBoard([this.sigleitems, this.mutilitems], this.name, this.number);         
                  // 渲染dom并且监听事件
                  this.update();
              }
              init(itemPool){
                  let _this = this;
                  for(let i of itemPool){
                      if(i.type === 'sigle'){
                          for(let item of i.items){
                              _this.sigleitems.push(new Item(item, 'sigle'));
                          }
                      }else if(i.type === 'mutil'){
                          for(let item of i.items){
                              _this.mutilitems.push(new Item(item, 'mutil'));
                          }
                      }
                  }
              }
              update(){
                  let _this = this;
                  let board = document.querySelector(_this.el);
                  // 渲染文章标题
                  board.appendChild((function(){
                      let title = document.createElement('div');
                      title.classList.add(_this.titleClass);
                      title.innerHTML = `<p>${_this.name}</p>`;
                      return title;
                  })());
                  // 渲染单选题
                  board.appendChild((function(){
                      let temp = document.createElement('div');
                      temp.classList.add(_this.cateClass);
                      // 渲染标题
                      temp.innerHTML = `<div class=${_this.cateTitleClass}><p>单选题</p></div>`;
                      // 渲染题目以及答案组
                      for(let i of _this.sigleitems){
                          temp.appendChild(i.update());
                      }
                      return temp;
                  })());
                  
                  // 渲染多选题
                  board.appendChild((function(){
                      let temp = document.createElement('div');
                      temp.classList.add(_this.cateClass);
                      // 渲染标题
                      temp.innerHTML = `<div class=${_this.cateTitleClass}><p>多选题</p></div>`;
                      // 渲染题目以及答案组
                      for(let i of _this.mutilitems){
                          temp.appendChild(i.update());
                      }
                      return temp;
                  })());
                  // 渲染按钮组
                  board.appendChild((function(){
                      let temp = document.createElement('div');
                      temp.classList.add(_this.buttonClass);
      
                      let confirm = document.createElement('button');
                      confirm.innerText = '提交';
                      confirm.addEventListener('click', _this.confirm.bind(_this));
      
                      temp.appendChild(confirm)
                      return temp;
                  })());
      
                  // 渲染结果弹出信息
                  board.appendChild(_this.answerBoard.layer.dom);
              }
              confirm(){
                  this.answerBoard.info();
              }
          }
      
          // 启动应用
          run(Test);
      }
    </script>
  </body>
</html>
